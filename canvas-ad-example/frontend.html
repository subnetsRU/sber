<!--
    Пример основан на: https://github.com/sberdevices/assistant-client/tree/main/examples/umd-example
    Для отладки эту страницу нужно открывать с параметром devel. Пример:
	https://example.ru/frontend.html?devel=true
    
    Пример как подключить рекламу в смартап: https://github.com/sberdevices/demo-ad-sdk
-->

<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sber canvas app example</title>
    <META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="expires" content="Mon, 01 Jan 1990 00:00:00 GMT">
    <META HTTP-EQUIV="Content-language" CONTENT="ru">
    <META NAME="author" CONTENT="Nikolaev Dmitry">
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@sberdevices/assistant-client@3.7.1/umd/assistant.min.js"></script>
    <script src="https://cdn-app.sberdevices.ru/shared-static/0.0.0/js/@sberdevices/ad-sdk/ad-sdk.min.js"></script>
</head>
<style>
body{
    background-color: #1A1A1A;
}
div#command{
    width: 90vw;
    overflow: auto;
    margin: 20px;
    padding: 10px;
    border: 1px solid red;
    color: white;
}
</style>
<body>
<div id="command"></div>
<button id="next">Далее</button>
<BR><BR>
<button id="ad">Запустить рекламу</button>

<script type="text/javascript">
    var state = { };
    const url = new URL(window.location.href);
    if (url.searchParams.get('devel') === 'true'){
        console.info('Start devel version');
        var token = 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIwYmY2ZjUwNzIzOWMyNGY5MDA5OTE3NWI4ZThlOGFiNTRlMWMxNjYxZTM4MzM0Y2E0MTYyMTA1ZmMxMjRkZjIwN2QyZmQwY2Q1ZWYyN2FiZiIsImF1ZCI6IlZQUyIsImV4cCI6MTY0MDA4OTY1OCwiaWF0IjoxNjQwMDAzMjQ4LCJpc3MiOiJLRVlNQVNURVIiLCJ0eXBlIjoiQmVhcmVyIiwianRpIjoiYmI3MDZkYWItMzk4Ni00YjMwLTg1ZDctYmE3NWI1MDEwNWMyIiwic2lkIjoiZWM3MjdhY2ItMjA4OC00M2M5LThiNTMtYzQ4YTc0ODAxMjkwIn0.M4WgD9T7qgA_XjTOAsTQxpwfJpn5L-sgkqn3xhBOzFV-MsaNC_NRANs46Jb_spVJYz3TfclUEJ7nCQKjR77ICwvWgLj1VBG6eTUxCAyM9-B1Mw523PjMt8QFoOBuwFzW5lgft7C2D0FqK2D4GP5qdlUPw2QQo2NQqhEkld6ToD9ph1fyint5RO3vaQToKJVIR6h5x1Ns-f6YZDeoWGse8yN8cpXDKtJ4LaqfEV3yv2KyMzXG919FiVACvlAyEmFZDc1ee5Nuqj4TPzYE2Z0Ihy6B_KLnL_fmTPKGKOJefbf7VFjEe949lRvPDBUvOghuAMoQbfhRB-JtW01JiPo4TjQn64lAkqBGvirMPt4J3YC9Qg8uN9bTDvPK7GqkC4M8fWS9WCPVYjEQtIlSACP33gMFv7x4xGWIQrgQLHNJoG7jcoJcrjlr6l98jS1rZ10591K8PDi_C4_QFHjv5EERtgQwfA9MXzUFf8B8TIx3DFak3pkIqhJywH1I9K4YXS5B5ZZ9T4EVuiVWReZ3jJTIrEfbjTw3AH2FVkTuxpTesLmp3Wdxhf3LnHCK3mvFGNquUnoglxgJtFXh92ciEZSk2jXIGrbuItidVBOJcim4Y-0DQwetm8OdzOCxrdhA6VaZg7-xEmlk950d8xOi8kaOzIT_bZHwy-TGgpHksXGRRLs'; // <- сюда вставляем токен из smartapp-studio (https://github.com/sberdevices/assistant-client/tree/main/examples/umd-example)
        var initPhrase = 'запусти мой канвас'; // <- сюда вставляем активационную фразу своего canvas app
        var ac = assistant.createSmartappDebugger({ getState: () => state, token, initPhrase });
    }else{
        console.info('Start production version');
        var ac = assistant.createAssistant({ getState: () => state });
    }

    var AD = {
	onError: function(e){
	    console.error('AD error',e);
	},
	onSuccess: function(){
	    console.info('AD init succsess. isInited:',window.SberDevicesAdSDK.isInited());
	},
	video: function(){
    	    if (typeof window.SberDevicesAdSDK !== "undefined"){
        	window.SberDevicesAdSDK.runVideoAd({
            	    mute: true,
            	    onSuccess: () => {
                	console.log('runVideoAd ended with success');
            	    },
            	    onError: (err) => {
                	console.log('runVideoAd ended with error',err);
        	    },
        	})
    	    }else{
        	console.error('window.SberDevicesAdSDK not defined',window.SberDevicesAdSDK);
    	    }
	},
    };

    var processData = function(command){
        console.info('got command',command);
        document.getElementById('command').innerHTML = JSON.stringify(command);
	
	if (command.type == "smart_app_data"){
	    data = (typeof command.smart_app_data != "undefined") ? command.smart_app_data : {};
	    //SberDevicesAdSDK
	    if (typeof data.ad !== "undefined"){
		console.log('Load SberDevicesAdSDK');
		let adInit = {
		    params: data.ad,	//<--- тут и вставляются данные, которые прислал наш backend
		    onSuccess: AD.onSuccess,
		    onError: AD.onError,
		};
		console.log('adInit',adInit);
		window.SberDevicesAdSDK.initWithParams(adInit);
	    }
	}
    }

    ac.on('start', (command) => {
        let initialData = ac.getInitialData();
        for(let i=0; i < initialData.length; i++){
            processData(initialData[i]);
        }
    });
    ac.on('data', (command) => {
        processData(command);
    });
    
    document.addEventListener("DOMContentLoaded", function(){
	let el = document.getElementById("next");
	el.addEventListener(
	    "click",
	    function(){
		console.log('send data to webhook',el.id);
		ac.sendData({ action: { action_id: el.id} });
	    },
	    false
	);
	let ad = document.getElementById("ad");
	ad.addEventListener(
	     "click",
	     function(){
	        console.log('Run ad video');
	        AD.video();
	    },
	    false
	);
    });
</script>
</body>
</html>