<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sber graph canvas app example</title>
    <META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
    <META HTTP-EQUIV="expires" content="Mon, 01 Jan 1990 00:00:00 GMT">
    <META HTTP-EQUIV="Content-language" CONTENT="ru">
    <META NAME="author" CONTENT="@WaxerDima @VirusNet">
    
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@sberdevices/assistant-client@3.3.1/umd/assistant.min.js"></script>
</head>
<style>
body{
    background-color: #1A1A1A;
    color: #ffffff;
}
div#command{
    width: 90vw;
    overflow: auto;
    margin: 20px;
    padding: 10px;
    border: 1px solid red;
    color: white;
}

ul {
    font-size: 14px;
    color: #ffffff;
    padding: 0;
    margin: 0;
}
ul li {
    display: inline-block;
    width: 150px;
    height: 150px;
    border: 2px solid white;
    border-radius: 5px;
    text-align: center;
    cursor: pointer;
}
ul li.onFocus{
    border-color: #9ecd09;
}
ul li:active {
    border: 2px solid #ff9900;
}
ul li.select {
    background-color: #ffffff;
}
ul li.win {
    background-color: #9ecd09;
    color: #9ecd09;
}

</style>

<body>
<div id="command">Debug: –¢—É—Ç –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤—Å—ë —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã. –û–∂–∏–¥–∞–µ–º –¥–∞–Ω–Ω—ã—Ö...</div>
<h1>–ò–≥—Ä–∞ –∫–æ–ª–ø–∞—á–∫–∏ v2.0</h1>
<center>
    <ul id="container">
	<li id="cap-1" data-number="–û–¥–∏–Ω">–û–¥–∏–Ω</li>
	<li id="cap-2" data-number="–î–≤–∞">–î–≤–∞</li>
	<li id="cap-3" data-number="–¢—Ä–∏">–¢—Ä–∏</li>
    </ul>
    <div id="current-number"></div>
</center>

<script type="text/javascript">
    /*
	–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
	–î–ª—è –æ—Ç–ª–∞–¥–∫–∏ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º devel. –ü—Ä–∏–º–µ—Ä:
	    https://example.ru/frontend.html?devel=true
	
	–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö token –∏ initPhrase (–æ–Ω–∏ —á—É—Ç—å –Ω–∏–∂–µ)
    */
    var token = ''; // <- —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ smartapp-studio (https://developer.sberdevices.ru/docs/ru/developer_tools/sdk/overview)
    var initPhrase = '–∑–∞–ø—É—Å—Ç–∏ –º–æ–π –º–µ–≥–∞ –ø—É–ø–µ—Ä –∫–∞–Ω–≤–∞—Å'; // <- —Å—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É –¥–ª—è —Ö–∞–ø—É—Å–∫–∞ –≤–∞—à–µ–≥–æ canvas app
    //
    
    //–û–ø—Ä–µ–¥–µ–ª—è–µ–º sberbox —ç—Ç–æ –∏–ª–∏ –Ω–µ—Ç
    var isBox = function(){
	let nav = window.navigator.userAgent.toLocaleLowerCase();
	return (/sberbox/.test(nav) || /satellite/.test(nav) || /tv/.test(nav));
    }
    
    var winNumber = null;
    function run(text) {
        var currentNumber = getNumberCap(text);
        document.querySelectorAll('li').forEach(item => item.className = 'select');
        if (winNumber === currentNumber) {
            document.getElementById('current-number').innerHTML = '<h2>–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! üëç </h2>';
            document.getElementById('cap-' + currentNumber).className = 'win'
        } else {
            document.getElementById('current-number').innerHTML = '<h2>–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ üòû</h2>';
        }
    }
    
    function getNumberCap(text) {
        switch(text) {
            case '–û–¥–∏–Ω':
                return 1;
            case '–î–≤–∞':
                return 2;
            case '–¢—Ä–∏':
                return 3;
        }
    }
    
    //–í—ã–¥–µ–ª—è–º —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ "–∫—É—Ä—Å–æ—Ä–∞" –ø—É–ª—å—Ç–æ–º Sberbox
    function addfocus(direct){
	let container = document.getElementById('container');
	if (!direct){
	    direct = 'right';
	}
	if (container){
	    let items = container.children;
	    let focusOn = null;
	    for(let i = 0; i < items.length; i++){
		if (items[i].classList.contains('onFocus')){
		    focusOn = i;
		}
		items[i].className = '';
	    }
	    if (typeof focusOn != "number"){
		focusOn = 0;
	    }
	    if (direct == "left"){
		focusOn -= 1;
	    }else{
		focusOn += 1;
	    }
	    if (typeof items[focusOn] === "undefined"){
		if (direct == "left"){
		    focusOn = (items.length - 1);
		}else{
		    focusOn = 0;
		}
	    }
	    if (typeof items[focusOn] !== "undefined"){
		items[focusOn].classList.add('onFocus');
	    }
	}
    }
    
    //–ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º assistant-client
    var state = { };
    const url = new URL(window.location.href);
    if (url.searchParams.get('devel') === 'true'){
        console.info('Start devel version');
        var ac = assistant.createSmartappDebugger({ getState: () => state, token, initPhrase });
    }else if (url.searchParams.get('devel') === 'local'){
	var ac = {
	    on: function(){},
	    sendData: function(data){console.log('skip send data',data);}
	};
    }else{
        console.info('Start production version');
        var ac = assistant.createAssistant({ getState: () => state });
    }
    
    //–†–∞–∑–±–∏—Ä–∞–µ–º –ø—Ä–∏—à–µ–¥—à–∏–µ (–æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã) –¥–∞–Ω–Ω—ã–µ
    var processData = function(command){
        console.info('got command',command);
        document.getElementById('command').innerHTML = JSON.stringify(command);
        if (command.type == "smart_app_data"){
	    if (typeof command.action !== "undefined" && typeof command.action.type !== "undefined"){
		let action = command.action;
		document.getElementById('command').innerHTML = 'action: ' + JSON.stringify(action);
        	switch(action.type){
            	    case 'START':
                	winNumber = command.action.winNumber;
                	document.getElementById('current-number').innerHTML = '';
                	document.querySelectorAll('li').forEach(item => item.className = '');
                	break;
            	    case 'SELECT_CAP':
                	select(action.select);
                	break;
            	    case 'EXIT':
            		console.log('Close smartapp');
            		if (ac && typeof ac.close === "function"){
			    ac.close();
			}
                	break;
            	    default:
                	console.error('Unsupported action-type', action.type);
                	break;
        	}
	    }
	}
    }

    //–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ back
    function select(number) {
	let SendToBack = {
            action: {action_id: 'SELECT_CAP', parameters: {select: number, winNumber: winNumber, win: getNumberCap(number) === winNumber}}
        }
	console.log('Select',number,SendToBack);
        run(number);
        var unsubscribe = ac.sendData(SendToBack, (data) => {
    	    winNumber = null;
            unsubscribe();
        });
    }

    //–ü—Ä–∏–Ω–∏–º–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    ac.on('start', (command) => {
        let initialData = ac.getInitialData();
        for(let i=0; i < initialData.length; i++){
            processData(initialData[i]);
        }
    });
    
    //–ü—Ä–∏–Ω–∏–º–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    ac.on('data', (command) => {
        processData(command);
    });

document.addEventListener("DOMContentLoaded", function(){
    //–ù–∞–≤–µ—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è
    let caps = document.getElementById('container').children;
    for(let i = 0; i < caps.length; i++){
	caps[i].addEventListener(
	    'click',
	    function(e){
		console.log('click on',this,'=>',this.dataset.number);
		select(this.dataset.number);
	    },
	    false
	);
    }
    
    //–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—É–ª—å—Ç–∞ sberbox
    if (isBox()){
	document.getElementById('container').children[0].classList.add('onFocus');
	window.addEventListener('keydown', (event) => {
	    if (!winNumber){
		return;
	    }
	    let key = event.key.toLowerCase().replace(/^arrow/,'');
	    console.log('key event',key);
	    switch(key) {
		case 'down':
    		// –≤–Ω–∏–∑
    		 break;
    		case 'up':
    	        // –≤–≤–µ—Ä—Ö
    		 break;
    		case 'left':
    		 // –≤–ª–µ–≤–æ
    		 addfocus('left');
    		 break;
    		case 'right':
    		// –≤–ø—Ä–∞–≤–æ
    		addfocus('right');
    		break;
    		case 'enter':
    		 // –æ–∫
    		if (typeof document.querySelectorAll('li.onFocus')[0] !== "undefined"){
    		    let event = new Event("click");
		    document.querySelectorAll('li.onFocus')[0].dispatchEvent(event);
		}
    		break;
	    }
	});
    }
});
</script>
</body>
</html>